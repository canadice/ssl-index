
###########################################################################
###########################################################################
###                                                                     ###
###                         PLAYER BUILDER TOOL                         ###
###                                                                     ###
###########################################################################
###########################################################################


### UI module for player similarities using MDS
playerDatabaseUI <- function(id){
  
  ## Creating the namespacing function for all iDs
  ns <- NS(id)
  
  tagList(
    fluidPage(
      fluidRow(
        tabBox(
          width = NULL,
          tabPanel(
            "Player Updater",
            
            fluidRow(
              ##-----------------------------------
              ##  Left hand side with information  
              ##-----------------------------------
              column(
                width = 4,
                box(
                  title = "Information",
                  status = "info",
                  solidHeader = TRUE,
                  width = NULL,
                  selectInput(
                    inputId = ns("player"),
                    label = "Select a player",
                    choices = playerData$Name %>% sort()
                  ),
                  h4("TPE Information", align = "center"),
                  fluidRow(
                    column(
                      width = 10,
                      offset = 1,
                      fluidRow(
                        column(
                          width = 6,
                          h5("Earned TPE")
                        ),
                        column(
                          width = 6,
                          numericInput(
                            inputId = ns("currentTPE"),
                            label = NULL,
                            value = 350,
                            min = 350,
                            max = 2500,
                            width = "80%"
                          )
                        )
                      ),
                      uiOutput(
                        outputId = ns("usedTPE")
                      )
                    )
                  ),
                  br(),
                  h5("Update Scale" %>% strong(), align = "center"),
                  DTOutput(
                    outputId = ns("costTPE"),
                    width = "80%"
                  ) %>% 
                    div(align = "center"),
                  actionButton(
                    inputId = ns("exportButton"),
                    label = "Export",
                    width = "80%"
                  ) %>%
                    div(align = "center")
                )
              ),
              
              ##------------------------------------
              ##  Right hand side with the builder  
              ##------------------------------------
              column(
                width = 8,
                p("Edit the Value column by double clicking on the cell."),
                DTOutput(ns("attributeTable"), width = "80%")
              )
              ##------------------------------------
            )
          )
        )
      )
    )
 )
}

## Backend module for player similarities
playerDatabaseSERVER <- function(id){
  ## Calling moduleServer function
  moduleServer(
    id,
    
    ## Definining the mechanisms
    function(input, output, session){
      
      
      ##---------------------------------------------------------------
      ##                        Reactive values                       -
      ##---------------------------------------------------------------
      
      currentAvailable <- reactiveVal(350)
      
      currentCost <- reactiveVal(0)
      
      ## Reactive data set that updates the input build of a player
      reactives <- reactiveValues(
        currentBuild = {
        playerData %>% 
          filter(Name == input$player) %>% 
          select(
            Acceleration:Throwing
          ) %>% 
          pivot_longer(
            cols = everything(),
            names_to = "Attribute",
            values_to = "Value"
          ) %>% 
          left_join(
            tpeCost,
            by = c("Value" = "value")
          ) %>% 
          mutate(
            cost = if_else(Attribute %in% c("Natural Fitness", "Stamina"), 0, cost)
          ) %>% 
          left_join(
            attributes,
            by = "Attribute"
          ) %>% 
          filter(
            !is.na(Value)
          ) %>% 
          select(
            -Keeper
          )
      })
      
      ##---------------------------------------------------------------
      ##                          Observers                           -
      ##---------------------------------------------------------------
      
      ## Observer that calculates the correct used TPE and available TPE for the build
      observeEvent(
        input$currentTPE,
        {
          currentAvailable(input$currentTPE - sum(reactives$currentBuild$cost))
          currentCost(sum(reactives$currentBuild$cost))
        },
        ignoreInit = FALSE
      )
      
      ## Observes a change in player and updates the current build and costs accordingly
      observeEvent(
        input$player,
        {
          reactives$currentBuild <- 
            playerData %>% 
            filter(Name == input$player) %>% 
            select(
              Acceleration:Throwing
            ) %>% 
            pivot_longer(
              cols = everything(),
              names_to = "Attribute",
              values_to = "Value"
            ) %>% 
            left_join(
              tpeCost,
              by = c("Value" = "value")
            ) %>% 
            mutate(
              cost = if_else(Attribute %in% c("Natural Fitness", "Stamina"), 0, cost)
            ) %>% 
            left_join(
              attributes,
              by = "Attribute"
            ) %>% 
            filter(
              !is.na(Value)
            ) %>% 
            select(
              -Keeper
            )
          
          currentAvailable(input$currentTPE - sum(reactives$currentBuild$cost))
          currentCost(sum(reactives$currentBuild$cost))
        }
      )
      
      observeEvent(
        input$attributeTable_cell_edit,
        {
          editedCell = input$attributeTable_cell_edit
          i = as.numeric(editedCell$row)
          j = as.numeric(editedCell$col)
          k = as.numeric(editedCell$value)
          
          # Checks if new value falls within attribute constraints
          if(k < 5){ 
            k <- 5
          } else if(k > 20) {
            k <- 20
          }
          
          # Checks if you alter the Natural Fitness or Stamina which are fixed attributes
          if(i %in% c(5,7)){
            k <- 20 
            
            reactives$currentBuild[i,j] <- k
          } else {
            #write values to reactive
            reactives$currentBuild[i,j] <- k
            
            reactives$currentBuild[i,"cost"] <- tpeCost$cost[tpeCost$value == k]  
          }
          
          currentAvailable(input$currentTPE - sum(reactives$currentBuild$cost))
          currentCost(sum(reactives$currentBuild$cost))
        }
      )
      
      
      ## Observer for the export button that creates a formatted text with all info of the build
      observeEvent(
        input$exportButton,
        {
          current <- 
            playerData %>% 
            filter(Name == input$player) %>% 
            select(
              Acceleration:Throwing
            ) %>% 
            pivot_longer(
              cols = everything(),
              names_to = "Attribute",
              values_to = "Value"
            ) %>% 
            left_join(
              tpeCost,
              by = c("Value" = "value")
            ) %>% 
            mutate(
              cost = if_else(Attribute %in% c("Natural Fitness", "Stamina"), 0, cost)
            ) %>% 
            left_join(
              attributes,
              by = "Attribute"
            ) %>% 
            filter(
              !is.na(Value)
            ) %>% 
            select(
              -Keeper
            )
          
          updated <- 
            reactives$currentBuild
          
          merged <- 
            current %>% 
            left_join(
              updated,
              by = "Attribute",
              suffix = c(".old", ".new")
            ) %>% 
            filter(
              Value.old != Value.new
            ) %>% 
            mutate(
              ChangeCost = cost.new - cost.old
            ) %>% 
            select(
              Attribute,
              Value.old,
              Value.new,
              ChangeCost
            )  
          
          if(merged %>% nrow() > 0){
            showModal(
              modalDialog(
                span(
                  "Copy the code below containing your updates into your update post."
                ),
                br(),
                br(),
                column(
                  width = 8,
                  offset = 2,
                  helpText(
                    paste(
                      paste(
                        paste("Earned TPE: ", input$currentTPE),
                        paste("Used TPE: ", currentCost()), 
                        paste("Banked TPE: ", currentAvailable()),
                        sep = "<br>"
                      ),
                      paste(
                        apply(
                          X = merged,
                          MARGIN = 1, 
                          FUN = function(merged){
                            paste(merged[1], paste(merged[2:3], collapse = " -> "), paste("(",merged[4], ")", sep = ""), collapse = " ")    
                          }
                        ),
                        collapse = "<br>"
                      ),
                      sep = "<br>"
                    ) %>% 
                      HTML()
                  ) %>% 
                    div(
                      style = "background: #f0f0f0; border: #656565"
                    )
                ),
                title="Update output",
                footer = 
                  tagList(
                    modalButton("Ok")
                  ),
                easyClose = TRUE
              )
            )
          } else {
            showModal(
              modalDialog(
                span(
                  "You have not changed your build yet."
                ),
                title="Update output",
                footer = 
                  tagList(
                    modalButton("Ok")
                  ),
                easyClose = TRUE
              )
            )
          }
          
        }
      )
      
      ##---------------------------------------------------------------
      ##                      Datatable outputs                       -
      ##---------------------------------------------------------------
      
      ## Table with the cost of all attribute values
      output$costTPE <- renderDT({
        datatable(
          data.frame(
            `Value` = c("5-7", "8-10", "11-13", "14-16", "17-18", "19-20"),
            Cost = c(2, 4, 6, 12, 18, 25)
          ),
          class = 'compact cell-border stripe',
          rownames = FALSE,
          style = "bootstrap",
          escape = FALSE,
          options = 
            list(
              ordering = FALSE,
              dom = 't',
              ## Sets color of table background
              initComplete = JS(
                "function(settings, json) {",
                "$(this.api().table().header()).css({'background-color': '#00044d', 'color': '#fff'});",
                "}")
            )
        )  
      })
      
      ## TPE information UI
      output$usedTPE <- renderUI({
        tagList(
          fluidRow(
            column(
              width = 6,
              h5("Used TPE")
            ),
            column(
              width = 6,
              h5(currentCost())
            )
          ),
          fluidRow(
            column(
              width = 6,
              h5("Available TPE")
            ),
            column(
              width = 6,
              h5(currentAvailable())
            )
          ),
          fluidRow(
            column(
              width = 6,
              h5("Forum TPE")
            ),
            column(
              width = 6,
              h5(playerData %>% filter(Name == input$player) %>% select(TPE) %>% unlist() %>% unname())
            )
          )
        )
      })
      
      ##----------------------------------------------------------------
      ##              Datatable output for attributes                  -
      ##----------------------------------------------------------------
      
      output$attributeTable <- renderDT({
        datatable(
          reactives$currentBuild %>% 
            relocate(
              Group,
              .before = Attribute
            ) %>% 
            rename(
              Cost = cost
            ), 
          rownames = FALSE,
          selection = "none",
          editable = 
            list(
              target = "cell",
              disable = 
                list(
                  columns = c(0,1,3)
                )
            ),
          extensions = "RowGroup",
          options = 
            list(
              rowGroup = list(datSrc = 0),
              ordering = FALSE, 
              pageLength = -1,
              dom = 'Rt',
              ## Sets color of table background
              initComplete = JS(
                "function(settings, json) {",
                "$(this.api().table().header()).css({'background-color': '#00044d', 'color': '#fff'});",
                "}")
            )
          )
      })
      
      
    }
  )
}

